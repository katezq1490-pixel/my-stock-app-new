<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockPulse AI - ç‹¬ç«‹ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Babel ç”¨äºè§£æ JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* ç®€å•çš„ Markdown æ ·å¼ */
        .prose h1 { font-size: 1.5rem; font-weight: 700; color: white; margin-top: 1.5rem; margin-bottom: 1rem; }
        .prose h2 { font-size: 1.25rem; font-weight: 700; color: white; margin-top: 1.5rem; margin-bottom: 0.75rem; border-bottom: 1px solid #334155; padding-bottom: 0.5rem; }
        .prose h3 { font-size: 1.125rem; font-weight: 600; color: #34d399; margin-top: 1.25rem; margin-bottom: 0.5rem; }
        .prose p { margin-bottom: 0.75rem; line-height: 1.6; color: #cbd5e1; }
        .prose strong { color: #e2e8f0; font-weight: 600; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; color: #cbd5e1; }
        .prose li { margin-bottom: 0.25rem; }
    </style>

    <!-- å…³é”®ä¿®å¤ï¼šæ·»åŠ  process polyfillï¼Œé˜²æ­¢ SDK æŠ¥é”™ -->
    <script>
        window.process = { env: { NODE_ENV: 'production' } };
    </script>

    <!-- å®šä¹‰ Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "@google/genai": "https://esm.sh/@google/genai"
        }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <!-- ä¸»ç¨‹åºé€»è¾‘ -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { GoogleGenAI } from '@google/genai';

        // --- API Key ç®¡ç†ç»„ä»¶ ---
        const ApiKeyModal = ({ onSave }) => {
            const [key, setKey] = useState('');
            
            const handleSubmit = (e) => {
                e.preventDefault();
                if (key.trim().length > 10) {
                    onSave(key.trim());
                } else {
                    alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ API Key");
                }
            };

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[100] p-4">
                    <div className="bg-slate-800 border border-slate-700 rounded-2xl p-8 max-w-md w-full shadow-2xl">
                        <h2 className="text-2xl font-bold text-white mb-4">é…ç½® Gemini API</h2>
                        <p className="text-slate-400 mb-6 text-sm">
                            è¿™æ˜¯ä¸€ä¸ªé™æ€ç½‘é¡µåº”ç”¨ï¼Œæ‚¨çš„ API Key ä»…ä¿å­˜åœ¨æ‚¨æœ¬åœ°æµè§ˆå™¨çš„ç¼“å­˜ä¸­ï¼Œä¸ä¼šå‘é€ç»™ä»»ä½•æœåŠ¡å™¨ã€‚
                        </p>
                        <form onSubmit={handleSubmit}>
                            <label className="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-2">API Key</label>
                            <input 
                                type="password" 
                                value={key}
                                onChange={(e) => setKey(e.target.value)}
                                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-emerald-500 outline-none mb-6"
                                placeholder="ç²˜è´´æ‚¨çš„ Key..."
                            />
                            <button type="submit" className="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-xl transition-colors">
                                ç¡®è®¤å¹¶ä¿å­˜
                            </button>
                            <div className="mt-4 text-center">
                                <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-xs text-emerald-400 hover:underline">
                                    æ²¡æœ‰ Key? å» Google AI Studio è·å–
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- æ ¸å¿ƒç»„ä»¶ ---

        const Header = ({ onResetKey }) => (
            <header className="w-full py-6 border-b border-slate-800 bg-slate-900/50 backdrop-blur-md sticky top-0 z-50">
                <div className="max-w-5xl mx-auto px-4 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-400 to-cyan-600 flex items-center justify-center shadow-lg shadow-emerald-500/20">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6 text-white">
                                <path fillRule="evenodd" d="M2.25 13.5a8.25 8.25 0 018.25-8.25.75.75 0 01.75.75v6.75H18a.75.75 0 01.75.75 8.25 8.25 0 01-16.5 0zm1.5 1.5a6.75 6.75 0 006.75 6.75v-6.75H3.75z" clipRule="evenodd" />
                                <path d="M13.5 1.515a.75.75 0 011.277 0c2.862 5.142 1.507 11.861-3.277 15.41v-4.06l4.27-3.202a.75.75 0 00-1.2-1.6l-3.07 2.303V1.515z" />
                            </svg>
                        </div>
                        <div>
                            <h1 className="text-2xl font-bold text-white tracking-tight">StockPulse AI</h1>
                            <p className="text-xs text-slate-400 font-medium uppercase tracking-wider">ç‹¬ç«‹ç‰ˆ Â· åŒå‡»å³ç”¨</p>
                        </div>
                    </div>
                    <button onClick={onResetKey} className="text-xs text-slate-500 hover:text-slate-300 transition-colors">
                        é‡ç½® Key
                    </button>
                </div>
            </header>
        );

        const StockInput = ({ onAddStock, disabled }) => {
            const [inputValue, setInputValue] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (inputValue.trim()) {
                    const rawSymbols = inputValue.split(/[,ï¼Œ\s]+/);
                    const validSymbols = rawSymbols.map(s => s.trim().toUpperCase()).filter(s => s.length > 0);
                    if (validSymbols.length > 0) {
                        onAddStock(validSymbols);
                        setInputValue('');
                    }
                }
            };

            return (
                <form onSubmit={handleSubmit} className="relative w-full max-w-md">
                    <div className="relative">
                        <input
                            type="text"
                            value={inputValue}
                            onChange={(e) => setInputValue(e.target.value)}
                            placeholder="è¾“å…¥ä»£ç  (å¦‚: AAPL, èŒ…å°, è…¾è®¯)"
                            disabled={disabled}
                            className="w-full pl-12 pr-4 py-4 bg-slate-800/50 border border-slate-700 rounded-2xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500 transition-all shadow-inner"
                        />
                        <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-5 h-5">
                                <path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                            </svg>
                        </div>
                        <button
                            type="submit"
                            disabled={!inputValue.trim() || disabled}
                            className="absolute right-2 top-2 bottom-2 px-4 bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-700 disabled:text-slate-500 text-white rounded-xl font-medium text-sm transition-colors shadow-lg shadow-emerald-900/20"
                        >
                            æ·»åŠ 
                        </button>
                    </div>
                </form>
            );
        };

        const AnalysisView = ({ result }) => {
            // ç®€å•çš„ markdown æ¸²æŸ“ï¼Œç›´æ¥ä½¿ç”¨ innerHTML é…åˆé¢„å¤„ç†æ¯”è¾ƒå±é™©ï¼Œè¿™é‡Œç”¨ç®€æ˜“çš„æ›¿æ¢é€»è¾‘
            // ä¸ºç®€åŒ–ä»£ç ï¼Œæˆ‘ä»¬å‡è®¾ result.markdown æ ¼å¼è‰¯å¥½ï¼Œä½¿ç”¨ CSS å¤„ç†æ ·å¼
            
            // å¤„ç†æ¢è¡Œå’ŒåŸºæœ¬æ ¼å¼
            const renderContent = () => {
                // å°† Markdown è½¬æ¢ä¸ºç®€å•çš„ HTML ç»“æ„ (ä»…ç”¨äºæ¼”ç¤ºï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ç”¨ marked ç­‰åº“)
                // è¿™é‡Œä¸ºäº†å•æ–‡ä»¶ç®€æ´æ€§ï¼Œæˆ‘ä»¬ç®€å•å¤„ç†æ ‡é¢˜å’Œåˆ—è¡¨
                let html = result.markdown
                    .replace(/### (.*)/g, '<h3>$1</h3>')
                    .replace(/## (.*)/g, '<h2>$1</h2>')
                    .replace(/# (.*)/g, '<h1>$1</h1>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/- (.*)/g, '<ul><li>$1</li></ul>')
                    .replace(/\n/g, '<br />');
                
                // ä¿®å¤è¿ç»­çš„ ul (ç®€å•çš„æ­£åˆ™æ›¿æ¢å¾ˆéš¾å®Œç¾ï¼Œä½†å¯¹å±•ç¤ºè¶³å¤Ÿ)
                html = html.replace(/<\/ul><br \/><ul>/g, ''); 
                
                return { __html: html };
            };

            return (
                <div className="animate-fade-in-up">
                    <div className="bg-slate-800/40 border border-slate-700 rounded-3xl p-6 md:p-8 backdrop-blur-sm shadow-xl mb-8">
                        <div className="prose prose-invert max-w-none" dangerouslySetInnerHTML={renderContent()} />
                    </div>

                    {result.sources && result.sources.length > 0 && (
                        <div className="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                            <h3 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                                æ¥æºä¸è®¨è®º
                            </h3>
                            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                                {result.sources.map((source, idx) => (
                                    <a key={idx} href={source.uri} target="_blank" rel="noopener noreferrer" className="group block p-3 rounded-xl bg-slate-800 hover:bg-slate-700 transition-all border border-slate-700 hover:border-emerald-500/30">
                                        <div className="overflow-hidden">
                                            <p className="text-sm text-slate-200 font-medium truncate group-hover:text-emerald-400 transition-colors">{source.title}</p>
                                            <p className="text-xs text-slate-500 truncate mt-0.5">{new URL(source.uri).hostname}</p>
                                        </div>
                                    </a>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- App ä¸»ç¨‹åº ---

        const App = () => {
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
            const [stocks, setStocks] = useState([]);
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);
            const [error, setError] = useState(null);

            // åŠ è½½ä¿å­˜çš„è‚¡ç¥¨
            useEffect(() => {
                const saved = localStorage.getItem('stockpulse_watchlist');
                if (saved) setStocks(JSON.parse(saved));
            }, []);

            // ä¿å­˜è‚¡ç¥¨
            useEffect(() => {
                localStorage.setItem('stockpulse_watchlist', JSON.stringify(stocks));
            }, [stocks]);

            const handleSaveKey = (key) => {
                localStorage.setItem('gemini_api_key', key);
                setApiKey(key);
            };

            const handleResetKey = () => {
                localStorage.removeItem('gemini_api_key');
                setApiKey('');
            };

            const addStocks = (symbols) => {
                const newStocks = [...stocks];
                const existing = new Set(stocks.map(s => s.symbol));
                symbols.forEach(sym => {
                    if (!existing.has(sym)) {
                        newStocks.push({ id: Date.now() + Math.random(), symbol: sym });
                    }
                });
                setStocks(newStocks);
            };

            const removeStock = (id) => {
                setStocks(stocks.filter(s => s.id !== id));
            };

            const runAnalysis = async () => {
                if (!apiKey) return;
                setLoading(true);
                setError(null);
                setResult(null);

                try {
                    const ai = new GoogleGenAI({ apiKey: apiKey });
                    const stockList = stocks.map(s => s.symbol).join(", ");
                    
                    const prompt = `
                        æˆ‘éœ€è¦ä»¥ä¸‹å…¬å¸çš„æƒ…æŠ¥ï¼š${stockList}ã€‚
                        è¯·åˆ©ç”¨ Google æœç´¢ï¼Œé’ˆå¯¹**ç¾è‚¡**å‚è€ƒ WSJ, Seeking Alpha, Redditï¼›é’ˆå¯¹**ä¸­å›½è‚¡ç¥¨**å‚è€ƒé›ªçƒã€è‚¡å§ã€è´¢æ–°ã€‚
                        
                        è¯·ç”Ÿæˆä¸€ä»½ä¸­æ–‡æŠ¥å‘Šï¼ŒåŒ…å«ï¼š
                        1. ğŸ“° **å…³é”®åŠ¨æ€** (News)
                        2. ğŸ—£ï¸ **ç¤¾åŒºè¾£è¯„** (æŒ–æ˜æ•£æˆ·å’ŒKOLçš„çœŸå®è§‚ç‚¹ï¼ŒåŒ…å«çœ‹å¤š/çœ‹ç©ºé€»è¾‘å’Œæ§½ç‚¹)
                        3. ğŸš¦ **æƒ…ç»ªæ€»ç»“**
                        
                        è¯·ä½¿ç”¨ Markdown æ ¼å¼ï¼ŒäºŒçº§æ ‡é¢˜åˆ†éš”è‚¡ç¥¨ã€‚
                    `;

                    const response = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: prompt,
                        config: { tools: [{ googleSearch: {} }] },
                    });

                    const text = response.text || "æ— å†…å®¹ç”Ÿæˆ";
                    const chunks = response.candidates?.[0]?.groundingMetadata?.groundingChunks || [];
                    const sources = chunks
                        .filter(c => c.web)
                        .map(c => ({ uri: c.web.uri, title: c.web.title }))
                        .filter((v, i, a) => a.findIndex(t => (t.uri === v.uri)) === i);

                    setResult({ markdown: text, sources });

                } catch (err) {
                    console.error(err);
                    setError("åˆ†æå¤±è´¥ï¼šè¯·æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®ï¼Œæˆ–ç½‘ç»œæ˜¯å¦é€šç•…ã€‚");
                    if (err.message.includes("401") || err.message.includes("API key")) {
                        handleResetKey();
                        alert("API Key æ— æ•ˆï¼Œè¯·é‡æ–°è¾“å…¥ã€‚");
                    }
                } finally {
                    setLoading(false);
                }
            };

            if (!apiKey) return <ApiKeyModal onSave={handleSaveKey} />;

            return (
                <div className="min-h-screen pb-12">
                    <Header onResetKey={handleResetKey} />
                    
                    <main className="max-w-5xl mx-auto px-4 py-12">
                        <div className="flex flex-col items-center text-center mb-10 space-y-6">
                            <p className="text-slate-400 text-base max-w-2xl">
                                æ‚¨çš„ç§äººæŠ•èµ„åŠ©ç† Â· è‡ªåŠ¨èšåˆå…¨çƒåª’ä½“ä¸ç¤¾åŒºæƒ…æŠ¥
                            </p>
                            
                            <StockInput onAddStock={addStocks} disabled={loading} />

                            <div className="flex flex-wrap justify-center gap-2 w-full max-w-3xl">
                                {stocks.map(stock => (
                                    <div key={stock.id} className="flex items-center gap-2 pl-3 pr-2 py-1.5 bg-slate-800 border border-slate-700 rounded-lg text-emerald-300 text-sm">
                                        <span>{stock.symbol}</span>
                                        <button onClick={() => removeStock(stock.id)} disabled={loading} className="text-slate-500 hover:text-red-400">âœ•</button>
                                    </div>
                                ))}
                                {stocks.length === 0 && <span className="text-slate-600 italic text-sm py-2">æ·»åŠ è‚¡ç¥¨ä»¥å¼€å§‹...</span>}
                            </div>

                            {stocks.length > 0 && (
                                <button 
                                    onClick={runAnalysis} 
                                    disabled={loading}
                                    className={`px-10 py-3 rounded-xl font-bold text-white shadow-xl transition-all ${loading ? 'bg-slate-700 cursor-wait' : 'bg-emerald-600 hover:bg-emerald-500 hover:scale-105'}`}
                                >
                                    {loading ? 'AI æ­£åœ¨æ€è€ƒä¸­...' : 'å¼€å§‹æœé›†æƒ…æŠ¥'}
                                </button>
                            )}
                        </div>

                        <div className="w-full h-px bg-slate-800/50 my-8"></div>

                        {error && (
                            <div className="bg-red-500/10 border border-red-500/20 rounded-2xl p-6 text-center text-red-300 mb-8">
                                {error}
                            </div>
                        )}

                        {result && <AnalysisView result={result} />}
                    </main>
                    
                    <footer className="text-center text-slate-600 text-xs pb-8">
                        <p>Â© StockPulse AI (Standalone v1.2 Fixed)</p>
                    </footer>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>